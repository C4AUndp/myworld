var countries = [
{id:1,name:"Afghanistan"},
{id:2,name:"Albania"},
{id:3,name:"Algeria"},
{id:4,name:"Andorra"},
{id:5,name:"Angola"},
{id:6,name:"Antigua and Barbuda"},
{id:7,name:"Argentina"},
{id:8,name:"Armenia"},
{id:9,name:"Australia"},
{id:10,name:"Austria"},
{id:11,name:"Azerbaijan"},
{id:12,name:"Bahamas"},
{id:13,name:"Bahrain"},
{id:14,name:"Bangladesh"},
{id:15,name:"Barbados"},
{id:16,name:"Belarus"},
{id:17,name:"Belgium"},
{id:18,name:"Belize"},
{id:19,name:"Benin"},
{id:20,name:"Bhutan"},
{id:21,name:"Bolivia (Plurinational State of)"},
{id:22,name:"Bosnia and Herzegovina"},
{id:23,name:"Botswana"},
{id:24,name:"Brazil"},
{id:25,name:"Brunei Darussalam"},
{id:26,name:"Bulgaria"},
{id:27,name:"Burkina Faso"},
{id:28,name:"Burundi"},
{id:29,name:"Cambodia"},
{id:30,name:"Cameroon"},
{id:31,name:"Canada"},
{id:32,name:"Cape Verde"},
{id:33,name:"Central African Republic"},
{id:34,name:"Chad"},
{id:35,name:"Chile"},
{id:36,name:"China"},
{id:37,name:"Colombia"},
{id:38,name:"Comoros"},
{id:39,name:"Congo"},
{id:40,name:"Costa Rica"},
{id:41,name:"Cote d'Ivoire"},
{id:42,name:"Croatia"},
{id:43,name:"Cuba"},
{id:44,name:"Cyprus"},
{id:45,name:"Czech Republic"},
{id:46,name:"Democratic People's Republic of Korea"},
{id:47,name:"Democratic Republic of the Congo"},
{id:48,name:"Denmark"},
{id:49,name:"Djibouti"},
{id:50,name:"Dominica"},
{id:51,name:"Dominican Republic"},
{id:52,name:"Ecuador"},
{id:53,name:"Egypt"},
{id:54,name:"El Salvador"},
{id:55,name:"Equatorial Guinea"},
{id:56,name:"Eritrea"},
{id:57,name:"Estonia"},
{id:58,name:"Ethiopia"},
{id:59,name:"Fiji"},
{id:60,name:"Finland"},
{id:61,name:"France"},
{id:62,name:"Gabon"},
{id:63,name:"Gambia"},
{id:64,name:"Georgia"},
{id:65,name:"Germany"},
{id:66,name:"Ghana"},
{id:67,name:"Greece"},
{id:68,name:"Grenada"},
{id:69,name:"Guatemala"},
{id:70,name:"Guinea"},
{id:71,name:"Guinea-Bissau"},
{id:72,name:"Guyana"},
{id:73,name:"Haiti"},
{id:74,name:"Honduras"},
{id:75,name:"Hungary"},
{id:76,name:"Iceland"},
{id:77,name:"India"},
{id:78,name:"Indonesia"},
{id:79,name:"Iran (Islamic Republic of)"},
{id:80,name:"Iraq"},
{id:81,name:"Ireland"},
{id:82,name:"Israel"},
{id:83,name:"Italy"},
{id:84,name:"Jamaica"},
{id:85,name:"Japan"},
{id:86,name:"Jordan"},
{id:87,name:"Kazakhstan"},
{id:88,name:"Kenya"},
{id:89,name:"Kiribati"},
{id:90,name:"Kuwait"},
{id:91,name:"Kyrgyzstan"},
{id:92,name:"Lao People's Democratic Republic"},
{id:93,name:"Latvia"},
{id:94,name:"Lebanon"},
{id:95,name:"Lesotho"},
{id:96,name:"Liberia"},
{id:97,name:"Libya"},
{id:98,name:"Liechtenstein"},
{id:99,name:"Lithuania"},
{id:100,name:"Luxembourg"},
{id:101,name:"Madagascar"},
{id:102,name:"Malawi"},
{id:103,name:"Malaysia"},
{id:104,name:"Maldives"},
{id:105,name:"Mali"},
{id:106,name:"Malta"},
{id:107,name:"Marshall Islands"},
{id:108,name:"Mauritania"},
{id:109,name:"Mauritius"},
{id:110,name:"Mexico"},
{id:111,name:"Micronesia (Federated States of)"},
{id:112,name:"Monaco"},
{id:113,name:"Mongolia"},
{id:114,name:"Montenegro"},
{id:115,name:"Morocco"},
{id:116,name:"Mozambique"},
{id:117,name:"Myanmar"},
{id:118,name:"Namibia"},
{id:119,name:"Nauru"},
{id:120,name:"Nepal"},
{id:121,name:"Netherlands"},
{id:122,name:"New Zealand"},
{id:123,name:"Nicaragua"},
{id:124,name:"Niger"},
{id:125,name:"Nigeria"},
{id:126,name:"Norway"},
{id:127,name:"Oman"},
{id:128,name:"Pakistan"},
{id:129,name:"Palau"},
{id:130,name:"Panama"},
{id:131,name:"Papua New Guinea"},
{id:132,name:"Paraguay"},
{id:133,name:"Peru"},
{id:134,name:"Philippines"},
{id:135,name:"Poland"},
{id:136,name:"Portugal"},
{id:137,name:"Qatar"},
{id:138,name:"Republic of Korea"},
{id:139,name:"Republic of Moldova"},
{id:140,name:"Romania"},
{id:141,name:"Russian Federation"},
{id:142,name:"Rwanda"},
{id:143,name:"Saint Kitts and Nevis"},
{id:144,name:"Saint Lucia"},
{id:145,name:"Saint Vincent and the Grenadines"},
{id:146,name:"Samoa"},
{id:147,name:"San Marino"},
{id:148,name:"Sao Tome and Principe"},
{id:149,name:"Saudi Arabia"},
{id:150,name:"Senegal"},
{id:151,name:"Serbia"},
{id:152,name:"Seychelles"},
{id:153,name:"Sierra Leone"},
{id:154,name:"Singapore"},
{id:155,name:"Slovakia"},
{id:156,name:"Slovenia"},
{id:157,name:"Solomon Islands"},
{id:158,name:"Somalia"},
{id:159,name:"South Africa"},
{id:160,name:"South Sudan"},
{id:161,name:"Spain"},
{id:162,name:"Sri Lanka"},
{id:163,name:"Sudan"},
{id:164,name:"Suriname"},
{id:165,name:"Swaziland"},
{id:166,name:"Sweden"},
{id:167,name:"Switzerland"},
{id:168,name:"Syrian Arab Republic"},
{id:169,name:"Tajikistan"},
{id:170,name:"Thailand"},
{id:171,name:"The former Yugoslav Republic of Macedonia"},
{id:172,name:"Timor-Leste"},
{id:173,name:"Togo"},
{id:174,name:"Tonga"},
{id:175,name:"Trinidad and Tobago"},
{id:176,name:"Tunisia"},
{id:177,name:"Turkey"},
{id:178,name:"Turkmenistan"},
{id:179,name:"Tuvalu"},
{id:180,name:"Uganda"},
{id:181,name:"Ukraine"},
{id:182,name:"United Arab Emirates"},
{id:183,name:"United Kingdom of Great Britain and Northern Ireland"},
{id:184,name:"United Republic of Tanzania"},
{id:185,name:"United States of America"},
{id:186,name:"Uruguay"},
{id:187,name:"Uzbekistan"},
{id:188,name:"Vanuatu"},
{id:189,name:"Venezuela (Bolivarian Republic of)"},
{id:190,name:"Viet Nam"},
{id:191,name:"Yemen"},
{id:192,name:"Zambia"},
{id:193,name:"Zimbabwe"}]

var m = [0, 0, 0, 0],
	    w = 884 - m[1] - m[3],
	    h = 500 - m[0] - m[2],
	    w2 = 428 - m[1] - m[3],
	    h2 = 255 - m[0] - m[2];

var svg = d3.select("#viz").append("svg:svg")
	        .attr("width", w + m[1] + m[3])
	        .attr("height", h + m[0] + m[2])
	        .attr("pointer-events", "all")
	      .append("svg:g")
	        .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

var ssvg = d3.select("#viz-small").append("svg:svg")
	        .attr("width", w2 + m[1] + m[3])
	        .attr("height", h2 + m[0] + m[2])
	        .attr("pointer-events", "all")
	      .append("svg:g")
	        .attr("transform", "translate(" + m[3] + "," + m[0] + ")");	        

var	sat = d3.scale.linear().domain([0, 100]).range([0, 1]),
	lum = d3.scale.linear().domain([0, 100]).range([1, 0.5])


var colors = [d3.rgb(253,253,253).toString(),d3.rgb(242,245,212).toString(),d3.rgb(234,238,173).toString(),d3.rgb(228,232,135).toString(),d3.rgb(221,228,89).toString(),d3.rgb(215,223,33).toString()]	
var colors2 = [d3.rgb(242,245,212).toString(),d3.rgb(234,238,173).toString(),d3.rgb(228,232,135).toString(),d3.rgb(221,228,89).toString(),d3.rgb(215,223,33).toString()]	

//console.log(colors2)


// Projection Settings
var projection = d3.geo.mercator()
				.scale([720])
				.translate([w/2,h/2+90]);

// Projection Settings
var projectionsmall = d3.geo.mercator()
				.scale([390])
				.translate([w2/2,h2/2+55]);

var geopath = d3.geo.path()
    .projection(projection);

var geopathsmall = d3.geo.path()
    .projection(projectionsmall);

var totalvotes = 0;
var data = {}
var newdata = []

// Load JSON Map and Voting Data
d3.json("viz/world.json", function(collection) {

	d3.json("http://votes2.myworld2015.org/votes.json", function(json) {
		json.forEach(function(d) {

			if (!data[d.country]) {
				data[d.country] = {
					id: d.country,
					name: countries[d.country-1].name,
					count: 0
				}
			}

			data[d.country].count ++;

		});

		for(x in data) {
			totalvotes += data[x].count;
			newdata.push(data[x]);
		}


		var pnumber = String(totalvotes).split('')
		var cnumber = String(newdata.length).split('')
		
		d3.select("#pnumber").html(
			"<span class='count'>" + "&nbsp;" +  
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>" + "&nbsp;" +  
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>" + "&nbsp;" + 
			"</span><span class='count'>"+pnumber[0]+"</span><span class='count'>"+pnumber[1]+"</span>"
			)
		d3.select("#cnumber").html(
			"<span class='count'>" + cnumber[cnumber.length-3] + "</span><span class='count'>" + 
			cnumber[cnumber.length-2]+"</span><span class='count'>" + 
			cnumber[cnumber.length-1] + "</span>"
			)

		d3.select("#cnumber-small").html(
			"<span class='count'>" + cnumber[cnumber.length-3] + "</span><span class='count'>" + 
			cnumber[cnumber.length-2]+"</span><span class='count'>" + 
			cnumber[cnumber.length-1] + "</span>"
			)

		// Render Paths Big Map
		var paths = svg.selectAll("path")
		      .data(collection.features)
		    .enter().append("path")
		    .attr({
		          d: function(d) { return geopath(d) },
		          id: function(d) { return d.properties.name; },
		          // count: function(d) { return Math.floor(Math.random()*11); },
		          fill: function(d,i) { 
		          		var p = getPosition(newdata,d.properties.name);
		          		if (p) {
			          		var c = newdata[p].count;
			          		if (c>1000000) {return colors[5]}
							if (c>100000) {return colors[4]}
							if (c>10000) {return colors[3]}
							if (c>100) {return colors[2]}
		          			if (c>0){return colors[1]}	          			
	          			}
		          		else { return colors[0] }
		            },
		          stroke:"#bbb",
		        })
		    .call(d3.helper.tooltip(function(d, i){
    			var t;
    			var p = getPosition(newdata,d.properties.name);
    			if (p) { t = newdata[p].count }
    			else { t = 0 }
				return "<span class='b'>" + d.properties.name + "</span><br>" + t +  " votes";
			}));


		// Render Paths Small Map
		var pathss = ssvg.selectAll("path2")
		      .data(collection.features)
		    .enter().append("path")
		    .attr({
		          d: function(d) { return geopathsmall(d) },
		          id: function(d) { return d.properties.name; },
		          // count: function(d) { return Math.floor(Math.random()*11); },
		          fill: function(d,i) { 
		          		var p = getPosition(newdata,d.properties.name);
		          		if (p) {
			          		var c = newdata[p].count;
			          		if (c>1000000) {return colors[5]}
							if (c>100000) {return colors[4]}
							if (c>10000) {return colors[3]}
							if (c>100) {return colors[2]}
		          			if (c>0){return colors[1]}	          			
	          			}
		          		else { return colors[0] }
		            },
		          stroke:"#bbb",
		        })
		    .call(d3.helper.tooltip(function(d, i){
    			var t;
    			var p = getPosition(newdata,d.properties.name);
    			if (p) { t = newdata[p].count }
    			else { t = 0 }
				return "<span class='b'>" + d.properties.name + "</span><br>" + t +  " votes";
			}));




			// Remove Antarctica
svg.select("#Antarctica").remove();
ssvg.select("#Antarctica").remove();
});


// ADD LEGEND
var legendpad = 145;
var legendtitles = ["0","1 - 100","100 - 10,000","10,000 - 100,000","100,000 - 1,000,000","1,000,000+"]

var legend = d3.select("#viz").append("svg:svg")
			.attr("width", w)
	        .attr("height", 20)
	        .attr("pointer-events", "all")
	      .append("svg:g")
	        .attr("transform", "translate(" + 40 + "," + 0 + ")");


var rect = legend.selectAll("rect.legend")
    	.data(colors)
    .enter().append("rect")
       	.attr("y", 0)
  		.attr("x", function (d,i) {return i*legendpad})
  		.attr("height", 12)
		.attr("width", 12)
		.style("fill", function (d,i) {return colors[i]})
		.style("stroke", "#ddd");

var texts = legend.selectAll("text.legend")
    	.data(legendtitles)
    .enter().append("svg:text")
       	.attr("y", 0)
  		.attr("x", function (d,i) {return (i*legendpad)+20})
  		.attr("dx", 0)
  		.attr("dy", 10)
  		.text(function (d,i) {return d})
		.style("font-size", "11px")
		.style("fill", "#111");


// ADD LEGEND SMALL
var legendpad2 = 95;
var legendtitles2 = ["1 - 100","100 - 10,000","10,000 - 100K","100K - 1M","1M+"]


var legend2 = d3.select("#viz-small").append("svg:svg")
			.attr("width", w2)
	        .attr("height", 30)
	        .attr("pointer-events", "all")
	      .append("svg:g")
	        .attr("transform", "translate(" + 0 + "," + 10 + ")");


var rect2 = legend2.selectAll("rect2.legend")
    	.data(colors2)
    .enter().append("rect")
       	.attr("y", 0)
  		.attr("x", function (d,i) {return i*legendpad2})
  		.attr("height", 12)
		.attr("width", 12)
		.style("fill", function (d,i) {return colors2[i]})
		.style("stroke", "#ddd");

var texts2 = legend2.selectAll("text2.legend")
    	.data(legendtitles2)
    .enter().append("svg:text")
       	.attr("y", 0)
  		.attr("x", function (d,i) {return (i*legendpad2)+15})
  		.attr("dx", 0)
  		.attr("dy", 10)
  		.text(function (d,i) {return d})
		.style("font-size", "10px")
		.style("fill", "#111");

});


function getPosition(arrayName,arrayItem){	
	for(var i=0;i<arrayName.length;i++){ 
		if(arrayName[i].name==arrayItem)
		return i;
	}
};

d3.helper = {};

d3.helper.tooltip = function(accessor){
    return function(selection){
        var tooltipDiv;
        var bodyNode = d3.select('body').node();
        selection.on("mouseover", function(d, i){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.svgtooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body').append('div').attr('class', 'svgtooltip');
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 15)+'px')
                .style('position', 'absolute') 
                .style('z-index', 999999);
            // Add text using the accessor function
            var tooltipText = accessor(d, i) || '';
            // Crop text arbitrarily
            tooltipDiv.style('width', function(d, i){return (tooltipText.length > 80) ? '300px' : null;})
                .html(tooltipText);
        })
        .on('mousemove', function(d, i) {
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style('left', (absoluteMousePos[0] + 10)+'px')
                .style('top', (absoluteMousePos[1] - 0)+'px');
            var tooltipText = accessor(d, i) || '';
            tooltipDiv.html(tooltipText);
        })
        .on("mouseout", function(d, i){
            // Remove tooltip
            tooltipDiv.remove();
        });

    };
};